<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="mailMapper">
	
	<resultMap id="MailResultSet" type="Mail">
		<id property="mailNum" column="mail_num"/>
		<result property="empId" column="emp_id"/>
		<result property="mailFrom" column="mail_from"/>
		<result property="mailTo" column="mail_to"/>
		<result property="mailCc" column="mail_cc"/>
		<result property="mailTitle" column="mail_title"/>
		<result property="mailContent" column="mail_content"/>
		<result property="originalFileName" column="original_filename"/>
		<result property="renameFileName" column="rename_filename"/>
		<result property="mailDate" column="mail_date"/>
		<result property="mailType" column="mail_type"/>
		<result property="mailImportant" column="mail_important"/>

	</resultMap>
	
	<!-- 페이징 처리 -->
	<select id="getListCount" parameterType="Mail" resultType="_int">
		SELECT count(*)
		FROM MAIL
		JOIN MAIL_DEL USING(MAIL_NUM)
		WHERE emp_id=#{empId}
			<if test="mailTo != null">
				and mail_to = #{mailTo} and status='Y'
			</if>
			<if test="mailFrom != null">
				and mail_from = #{mailFrom} and status='Y'
			</if>
			<if test="status != null">
				and status = #{status}
			</if>
		ORDER BY MAIL_NUM DESC
	</select>
	
	<!-- 받은 메일함 조회 -->
	<select id="receiveMailList" parameterType="Mail" resultMap="MailResultSet">
		SELECT MAIL_NUM, EMP_ID, MAIL_FROM, MAIL_TO, MAIL_TITLE, MAIL_DATE, MAIL_IMPORTANT, RENAME_FILENAME, STATUS
		FROM MAIL
		JOIN MAIL_DEL USING(MAIL_NUM)
		WHERE EMP_ID=#{empId} AND STATUS='Y'
		ORDER BY MAIL_NUM DESC
	</select>
	
	<!-- 보낸 메일함 조회 -->
	<select id="sendMailList" parameterType="Mail" resultMap="MailResultSet">
		SELECT MAIL_NUM, EMP_ID, MAIL_FROM, MAIL_TO, MAIL_TITLE, MAIL_DATE, MAIL_IMPORTANT, RENAME_FILENAME, STATUS
		FROM MAIL
		JOIN MAIL_DEL USING(MAIL_NUM)
		WHERE EMP_ID=#{empId} AND STATUS='Y'
		ORDER BY MAIL_NUM DESC
	</select>
	
	<!-- 휴지통 조회 -->
	<select id="deleteMailList" parameterType="Employee" resultMap="MailResultSet">
		SELECT MAIL_NUM, EMP_ID, MAIL_FROM, MAIL_TO, MAIL_TITLE, MAIL_DATE, MAIL_IMPORTANT, RENAME_FILENAME, STATUS
		FROM MAIL
		JOIN MAIL_DEL USING(MAIL_NUM)
		WHERE STATUS='N' AND EMP_ID=#{empId}
		ORDER BY MAIL_NUM DESC
		
	</select>
	
	<!-- 메일 완전 삭제시, 메일 셀렉 -->
	<select id="selectMail" parameterType="Mail" resultMap="MailResultSet">
		select *
		from mail
		where mail_num=#{mailNum}
	</select>
	
	<!-- tomail empid 받아오기 -->
	<select id="selectEmpId" parameterType="String" resultType="_int">
		select emp_id
		from employee
		where email = #{toEmail}
	</select>
	
	<!-- 메일 보내기 -->
	<insert id="insertMail" parameterType="Mail">
		insert into mail
		values (mail_seq.nextval,#{mailFrom},#{mailTo},#{mailCc},#{mailTitle},#{mailContent},
		        #{originalFileName},#{renameFileName},sysdate,default,default)
	</insert>
	
	<!-- 메일 삭제 테이블 인서트 -->
	<insert id="insertStatusMail" parameterType="_int">
		insert into mail_del
		values (mail_seq.currval,#{empId},default)
	</insert>
	
	<!-- 메일함 디테일 -->
	<select id="receiveDetail" parameterType="_int" resultMap="MailResultSet">
		select *
		from mail
		where mail_num=#{mailNum}
	</select>
	
	<!-- 메일 검색결과 게시글 수 조회용 쿼리문 -->
	<select id="selectSearchCount" resultType="_int">
		SELECT COUNT(*)
		FROM MAIL
		JOIN MAIL_DEL USING(MAIL_NUM)
		WHERE EMP_ID=#{empId}
		<choose>
			<when test="writer != null">
				and mail_from like '%' || #{writer} || '%'
			</when>
			<when test="title != null">
				and mail_title like '%' || #{title} || '%'
			</when>
			<otherwise>
				and mail_content like '%' || #{content} || '%'
			</otherwise>
		</choose>
	</select>
	
	<!-- 메일 검색결과에 해당하는 게시글 목록 조회 -->
	<select id="selectSearchList" resultMap="MailResultSet">
		SELECT MAIL_NUM, EMP_ID, MAIL_FROM, MAIL_TO, MAIL_TITLE, MAIL_DATE, MAIL_IMPORTANT, RENAME_FILENAME, STATUS
		FROM MAIL
		JOIN MAIL_DEL USING(MAIL_NUM)
		WHERE EMP_ID=#{empId}
		<choose>
			<when test="writer != null">
				and mail_from like '%' || #{writer} || '%'
			</when>
			<when test="title != null">
				and mail_title like '%' || #{title} || '%'
			</when>
			<otherwise>
				and mail_content like '%' || #{content} || '%'
			</otherwise>
		</choose>
		order by mail_num desc
	</select>
	
	<!-- 메일함 휴지통 이동 -->
	<update id="updateMail" parameterType="Mail">
		update mail_del
		set status='N'
		where mail_num=#{mailNum} and emp_id=#{empId}
	</update>
	
	<!-- 메일 완전 삭제 -->
	<delete id="deleteMail" parameterType="Mail">
		delete from mail_del
		where mail_num=#{mailNum} and emp_id=#{empId}
	</delete>
	
	<update id="restoreMail" parameterType="Mail">
		update mail_del
		set status='Y'
		where mail_num=#{mailNum} and emp_id=#{empId}
	</update>

</mapper>
