<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="chatMapper">
	
	<resultMap id="chatListResult" type="Chat">
		<id property="chatId" column="chat_id"/>
		<result property="chatName" column="chat_name"/>
		<result property="createDate" column="create_date"/>
		<result property="modifyDate" column="modify_date"/>
		<result property="lastMsg" column="m_content"/>
		<result property="chatType" column="chat_type"/>
		<result property="count" column="chat_count"/>
		<result property="unRead" column="join_count"/>
	</resultMap>
	
	<resultMap id="chatProfileResult" type="Message">
		<id property="chatId" column="chat_id"/>
		<id property="empId" column="emp_id"/>
		<result property="profilePath" column="profile_path"/>
	</resultMap>
	
	<resultMap id="messageListResult" type="Message">
		<id property="msgId" column="msg_id"/>
		<result property="chatId" column="chat_id"/>
		<result property="empId" column="emp_id"/>
		<result property="empName" column="emp_name"/>
		<result property="jobName" column="job_name"/>
		<result property="profilePath" column="profile_path"/>
		<result property="content" column="m_content"/>
		<result property="createDate" column="m_create_date"/>
		<result property="originName" column="origin_name"/>
		<result property="changeName" column="change_name"/>
		<result property="status" column="m_status"/>
		<result property="validity" column="validity"/>
	</resultMap>
	
	<!-- 채팅방 리스트 출력용 서비스 -->
	<select id="selectChatList" parameterType="_int" resultMap="chatListResult">
		select *
		from chatlist_view
		where emp_id = #{empId}
	</select>
	
	<!-- 채팅방 사람들 프로필 경로 출력용 서비스 -->
	<select id="selectChatProfile" parameterType="_int" resultMap="chatProfileResult">
		SELECT J.CHAT_ID, J.EMP_ID, PROFILE_PATH
		FROM JOIN_CHAT J
		JOIN CHAT C ON(J.CHAT_ID = C.CHAT_ID)
		JOIN EMPLOYEE E ON(J.EMP_ID = E.EMP_ID)
		WHERE CHAT_STATUS = 'Y' AND J.EMP_ID != #{empId}
	</select>
	
	<!-- 채팅 삽입 -->
	<insert id="insertMessage" parameterType="Message">
		INSERT INTO MESSAGE
		VALUES(MSG_SEQ.NEXTVAL, #{chatId}, #{empId}, #{content}, SYSDATE, DEFAULT)
	</insert>
	
	<!-- 채팅방 갱신 -->
	<update id="updateChatMod" parameterType="_int">
		UPDATE CHAT
		SET MODIFY_DATE = (SELECT MAX(M_CREATE_DATE)
		                   FROM MESSAGE
		                   WHERE CHAT_ID = #{chatId}
		                   GROUP BY CHAT_ID)
		WHERE CHAT_ID = #{chatId}
	</update>
	
	<!-- 채팅방 확인 갱신 -->
	<update id="updateJoinMod" parameterType="Message">
		UPDATE JOIN_CHAT
		SET MODIFY_DATE = SYSDATE
		WHERE CHAT_ID = #{chatId} AND EMP_ID = #{empId}
	</update>
	
	<!-- 채팅 리스트 출력용 서비스 -->
	<select id="selectMsgList" parameterType="_int" resultMap="messageListResult">
		SELECT *
		FROM MESSAGE_LIST
		WHERE CHAT_ID = #{chatId}
	</select>
	
	<select id="selectUsers" parameterType="_int" resultMap="chatProfileResult">
		SELECT EMP_ID
		FROM JOIN_CHAT
		WHERE CHAT_ID = #{chatId}
	</select>

</mapper>
